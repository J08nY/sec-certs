{% macro keywords_card(keyword_scan, doc_prefix, card_id, card_name, keyword_sources, hidden, map_funcs) %}
	{% set ns = namespace(render=False) %}
	{% for heading, keyword in keyword_sources.items() %}
		{% if keyword not in hidden and keyword_scan[keyword] %}
			{% set ns.render = True %}
		{% endif %}
	{% endfor %}
	{% if ns.render %}
		<div class="card mt-1">
			<div class="card-header" id="{{ doc_prefix }}-{{ card_id }}-head">
			<h4 class="mb-0">
				<button class="btn btn-link" data-toggle="collapse" data-target="#{{ doc_prefix }}-{{ card_id }}-card" aria-expanded="false" aria-controls="{{ doc_prefix }}-{{ card_id }}-card">
				{{ card_name }}
				</button>
			</h4>
			</div>

			<div id="{{ doc_prefix }}-{{ card_id }}-card" class="collapse" aria-labelledby="{{ doc_prefix }}-{{ card_id }}-head">
			<div class="card-body">
				{% for heading, keyword in keyword_sources.items() %}
					{% if keyword not in hidden and keyword_scan[keyword] %}
						<h5 class="mt-2">{{ heading }}</h5>
						{{ double_join(keyword_scan[keyword], map_func=map_funcs.get(keyword, None)) }}
					{% endif %}
				{% endfor %}
			</div>
			</div>
		</div>
	{% endif %}
{% endmacro %}

{% macro cryptography_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
	{{ keywords_card(keyword_scan, doc_prefix, "crypto", "Cryptography", {"Algorithms": "rules_crypto_algs",
																		  "Engines": "rules_crypto_engines",
																		  "Libraries": "rules_crypto_libraries",
																		  "Elliptic Curves": "rules_ecc_curves"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro device_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
	{{ keywords_card(keyword_scan, doc_prefix, "device", "Device", {"Device ID": "rules_device_id",
																	"JavaCard": "rules_javacard",
																	"OS": "rules_os",
																	"CPLC": "rules_cplc"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro security_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
	{{ keywords_card(keyword_scan, doc_prefix, "security", "Security", {"Protection profiles": "rules_protection_profiles",
																		"Security Assurance Requirements (SAR)": "rules_security_assurance_components",
																		"Security Functional Requirements (SFR)": "rules_security_functional_components",
																		"Security level": "rules_security_level"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro other_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
	{{ keywords_card(keyword_scan, doc_prefix, "other", "Other", {"Standards": "rules_standard_id",
																  "Technical reports": "rules_technical_reports"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro double_join(rule_dict, separator=", ", map_func=None) %}
	{% for value in rule_dict.values() %}
		{% for inside in value.keys() %}
			{% if map_func %}
				{{ map_func(inside) }}
			{% else %}
				{{ inside }}
			{% endif %}
			{%- if not loop.last -%}{{ separator }}{%- endif -%}
		{% endfor %}
		{%- if not loop.last -%}{{ separator }}{%- endif -%}
	{% endfor %}
{%- endmacro %}

{% macro render_status(status) %}
	{% if status == "active" %}
	<span class="text-success"><i class="fas fa-check-square"></i> active</span>
	{% elif status == "archived" %}
	<span class="text-warning"><i class="fas fa-times-circle"></i> archived</span>
	{% else %}
	<span>{{ status }}</span>
	{% endif %}
{%- endmacro %}

{% macro render_category(category) %}
<span title="{{ category }}">
{% if category == "Access Control Devices and Systems" %}
	<i class="fas fa-fw fa-id-card-alt"></i>
{% elif category == "Biometric Systems and Devices" %}
	<i class="fas fa-fw fa-fingerprint"></i>
{% elif category == "Boundary Protection Devices and Systems" %}
	<i class="fas fa-fw fa-door-closed"></i>
{% elif category == "Databases" %}
	<i class="fas fa-fw fa-database"></i>
{% elif category == "Data Protection" %}
	<i class="fas fa-fw fa-shield-alt"></i>
{% elif category == "Detection Devices and Systems" %}
	<i class="fas fa-fw fa-eye"></i>
{% elif category == "ICs, Smart Cards and Smart Card-Related Devices and Systems" %}
	<i class="fas fa-fw fa-credit-card"></i>
{% elif category == "Key Management Systems" %}
	<i class="fas fa-fw fa-key"></i>
{% elif category == "Mobility" %}
	<i class="fas fa-fw fa-car"></i>
{% elif category == "Multi-Function Devices" %}
	<i class="fas fa-fw fa-server"></i>
{% elif category == "Network and Network-Related Devices and Systems" %}
	<i class="fas fa-fw fa-network-wired"></i>
{% elif category == "Operating Systems" %}
	<i class="fas fa-fw fa-desktop"></i>
{% elif category == "Other Devices and Systems" %}
	<i class="fas fa-fw fa-square"></i>
{% elif category == "Products for Digital Signatures" %}
	<i class="fas fa-fw fa-signature"></i>
{% elif category == "Trusted Computing" %}
	<i class="fas fa-fw fa-microchip"></i>
{% endif %}
</span>
{%- endmacro %}

{% macro render_sfrs(sfr) %}
	{% if get_cc_sfr(sfr) %}
		<abbr title="{{ get_cc_sfr(sfr) }}">{{ sfr }}</abbr>
	{% else %}
		{{ sfr }}
	{% endif %}
{%- endmacro %}

{% macro render_sars(sar) %}
	{% if get_cc_sar(sar) %}
		<abbr title="{{ get_cc_sar(sar) }}">{{ sar }}</abbr>
	{% else %}
		{{ sar }}
	{% endif %}
{%- endmacro %}