{% macro render_local_file(hashid, link_content, link, local_files, document, primary_style, secondary_style) %}
    <div class="btn-group">
        <a class="btn {{ primary_style }}" role="button" href="{{ link }}"
           data-bs-toggle="tooltip" data-bs-placement="bottom"
           title="{{ link.split("/")[-1] if "/" in link else link }}">{{ link_content|safe }}</a>
        {% for format in ("pdf", "txt") %}
            {% if local_files.get((document, format)) %}
                <a class="btn {{ secondary_style }}" role="button"
                   href="{{ url_for(".entry_" + document + "_" + format, hashid=hashid) }}"
                   data-bs-toggle="tooltip" data-bs-placement="bottom"
                   title="Local download">{{ format.upper() }}</a>
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}

{% macro render_local_files(hashid, local_files, cert_link, report_link, target_link, primary_style="btn-outline-primary", secondary_style="btn-outline-secondary") %}
    {% if cert_link %}
        {{ render_local_file(hashid, '<i class="fas fa-file-contract"></i> Certificate', cert_link, local_files, "cert", primary_style, secondary_style) }}
    {% endif %}
    {% if report_link %}
        {{ render_local_file(hashid, '<i class="fas fa-file-contract"></i> Certification report', report_link, local_files, "report", primary_style, secondary_style) }}
    {% endif %}
    {% if target_link %}
        {{ render_local_file(hashid, '<i class="fas fa-file-alt"></i> Security target', target_link, local_files, "target", primary_style, secondary_style) }}
    {% endif %}
{% endmacro %}

{% macro render_cve_impact(cve) %}
    {% if cve["impact"]["severity"] == "CRITICAL" %}
        <span style="color: var(--bs-red)"><i class="fas fa-fw fa-exclamation-triangle"></i></span>
        CRITICAL
    {% elif cve["impact"]["severity"] == "HIGH" %}
        <span style="color: var(--bs-orange)"><i class="fas fa-fw fa-exclamation-circle"></i></span>
        HIGH
    {% elif cve["impact"]["severity"] == "MEDIUM" %}
        <span style="color: var(--bs-yellow)"><i class="fas fa-fw fa-exclamation"></i></span> MEDIUM
    {% elif cve["impact"]["severity"] == "LOW" %}
        <span style="color: var(--bs-green)"><i class="fas fa-fw fa-exclamation"></i></span> LOW
    {% else %}
        {{ cve["impact"]["severity"] }}
    {% endif %}
{% endmacro %}

{% macro render_cve_links(cve, full=False) %}
    <div class="btn-group" role="group" aria-label="Basic example">
        <a href="https://www.cve.org/CVERecord?id={{ cve["cve_id"] }}"
           target="_blank" rel="noopener" title="CVE at cve.org"
           class="btn btn-outline-secondary btn-sm">{% if full %}cve.org{% else %}C{% endif %}</a>
        <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name={{ cve["cve_id"] }}"
           target="_blank" rel="noopener" title="CVE at cve.mitre.org"
           class="btn btn-outline-secondary btn-sm">{% if full %}cve.mitre.org{% else %}M{% endif %}</a>
        <a href="https://nvd.nist.gov/vuln/detail/{{ cve["cve_id"] }}" target="_blank"
           rel="noopener" title="CVE in NIST's Vulnerability Database"
           class="btn btn-outline-secondary btn-sm">{% if full %}nvd.nist.gov{% else %}N{% endif %}</a>
    </div>
{% endmacro %}

{% macro render_cves(cves) %}
    <table class="table table-striped my-2">
        <colgroup>
            <col style="width:15%">
            <col style="width:10%">
            <col style="width:20%">
            <col style="width:10%">
            <col style="width:10%">
            <col style="width:10%">
            <col style="width:15%">
        </colgroup>
        <thead class="table-light">
        <tr>
            <th scope="col" colspan="1" rowspan="2">ID</th>
            <th scope="col" colspan="1" rowspan="2">Links</th>
            <th scope="col" colspan="1" rowspan="2">Severity</th>
            <th scope="col" colspan="3">CVSS Score</th>
            <th scope="col" colspan="1" rowspan="2">Published on</th>
        </tr>
        <tr>
            <th scope="col" style="border-bottom-color: #dfe0e1">Base</th>
            <th scope="col" style="border-bottom-color: #dfe0e1">Exploitability</th>
            <th scope="col" style="border-bottom-color: #dfe0e1">Impact</th>
        </tr>
        </thead>
        <tbody>
        {% set years = namespace(cve=None, current=None) %}
        {% for cve in cves %}
            {% set years.current = cve["cve_id"].split("-")[1] %}
            <tr {% if years.current != years.cve and years.cve %}
                style="border-top: 2px solid var(--bs-dark)"{% endif %}>
                <td><a href="{{ url_for("vuln.cve", cve_id=cve["cve_id"]) }}">{{ cve["cve_id"] }}</a></td>
                <td>
                    {{ render_cve_links(cve) }}
                </td>
                <td>
                    {{ render_cve_impact(cve) }}
                </td>
                <td>{{ cve["impact"]["base_score"] }}</td>
                <td>{{ cve["impact"]["explotability_score"] }}</td>
                <td>{{ cve["impact"]["impact_score"] }}</td>
                <td>{{ cve["published_date"]|fromisoformat()|strftime("%d.%m.%Y %H:%M") }}</td>

            </tr>
            {% set years.cve = years.current %}
        {% endfor %}
        </tbody>
    </table>
{%- endmacro %}