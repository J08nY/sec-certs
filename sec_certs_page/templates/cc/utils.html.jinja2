{% from "common/entry.html.jinja2" import keywords_card %}

{% macro cc_keywords(keyword_scan, doc_prefix, hidden=[], map_funcs={}) -%}
    {{ keywords_card(keyword_scan, doc_prefix, "security", "Security", {"Security level": "cc_security_level",
                                                                        "Claims": "cc_claims",
																		"Security Assurance Requirements (SAR)": "cc_sar",
																		"Security Functional Requirements (SFR)": "cc_sfr",
																		"Protection profiles": "cc_protection_profile_id",
																		"Certificates": "cc_cert_id",
																		"Evaluation facilities": "eval_facility",
																		"Certification process": "certification_process"}, hidden, map_funcs) }}
{%- endmacro %}

{% macro opt_line(name, key, obj, title) %}
    {% if key in obj and obj[key] %}
        <tr data-cs-name="{{ title }} - {{ name }}">
            <th scope="row">{{ name }}:</th>
            <td>{{ obj[key] }}</td>
        </tr>
    {% endif %}
{%- endmacro %}

{% macro render_pdf_meta(pdf_meta, title) %}
    <table class="table table-sm table-borderless table-dark w-auto">
        <tbody>
        {{ opt_line("Title", "/Title", pdf_meta, title) }}
        {{ opt_line("Subject", "/Subject", pdf_meta, title) }}
        {{ opt_line("Keywords", "/Keywords", pdf_meta, title) }}
        {{ opt_line("Author", "/Author", pdf_meta, title) }}
        {{ opt_line("Creation date", "/CreationDate", pdf_meta, title) }}
        {{ opt_line("Modification date", "/ModDate", pdf_meta, title) }}
        {{ opt_line("Pages", "pdf_number_of_pages", pdf_meta, title) }}
        {{ opt_line("Creator", "/Creator", pdf_meta, title) }}
        {{ opt_line("Producer", "/Producer", pdf_meta, title) }}
        </tbody>
    </table>
{%- endmacro %}

{% macro render_frontpage(cert, doc_type, title) %}
    {% if cert["pdf_data"][doc_type] %}
        {% if cert["pdf_data"][doc_type]["anssi"] %}
            {% set frontpage = cert["pdf_data"][doc_type]["anssi"] %}
        {% elif cert["pdf_data"][doc_type]["bsi"] %}
            {% set frontpage = cert["pdf_data"][doc_type]["bsi"] %}
        {% elif cert["pdf_data"][doc_type]["niap"] %}
            {% set frontpage = cert["pdf_data"][doc_type]["niap"] %}
        {% elif cert["pdf_data"][doc_type]["canada"] %}
            {% set frontpage = cert["pdf_data"][doc_type]["canada"] %}
        {% elif cert["pdf_data"][doc_type]["nscib"] %}
            {% set frontpage = cert["pdf_data"][doc_type]["nscib"] %}
        {% endif %}
        {% if frontpage %}
            <h3 class="mt-3">Frontpage</h3>
            <table class="table table-sm table-borderless table-dark w-auto">
                <tbody>
                {{ opt_line("Certificate ID", "cert_id", frontpage, title) }}
                {{ opt_line("Certified item", "cert_item", frontpage, title) }}
                {{ opt_line("Certification lab", "cert_lab", frontpage, title) }}
                {{ opt_line("Developer", "developer", frontpage, title) }}
                </tbody>
            </table>
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro render_status(status) %}
    {% if status == "active" %}
        <span class="text-success"><i class="fas fa-check-square"></i> active</span>
    {% elif status == "archived" %}
        <span class="text-warning"><i class="fas fa-times-circle"></i> archived</span>
    {% else %}
        <span>{{ status }}</span>
    {% endif %}
{%- endmacro %}

{% macro render_document_type(document_type) %}
    {% if document_type == "report" %}
        <span>Certification Report</span>
    {% elif document_type == "target" %}
        <span>Security Target</span>
    {% endif %}
{%- endmacro %}

{% macro render_category(category) %}
    <span title="{{ category }}">
    {% set cat = get_cc_category(category) %}
        {% if cat %}
            <i class="fas fa-fw {{ cat['icon'] }}"></i>
        {% endif %}
    </span>
{%- endmacro %}

{% macro render_eal(eal) %}
    {% set ealm = eal.replace("+", "") %}
    {%- if get_cc_eal(ealm) -%}
        <abbr title="{{ get_cc_eal(ealm)["name"] }}">{{ eal }}</abbr>
    {%- elif get_cc_sar(eal) -%}
        <abbr title="{{ get_cc_sar(eal) }}">{{ eal }}</abbr>
    {%- else -%}
        {{ eal }}
    {%- endif -%}
{%- endmacro %}

{% macro render_sfrs(sfr) %}
    {%- if get_cc_sfr(sfr) -%}
        <abbr title="{{ get_cc_sfr(sfr) }}">{{ sfr }}</abbr>
    {%- else -%}
        {{ sfr }}
    {%- endif -%}
{%- endmacro %}

{% macro render_sars(sar) %}
    {%- if get_cc_sar(sar) -%}
        <abbr title="{{ get_cc_sar(sar) }}">{{ sar }}</abbr>
    {%- else -%}
        {{ sar }}
    {%- endif -%}
{%- endmacro %}

{% macro render_pagination(pagination, certs, search=False) %}
    <div id="pagination">
        {% if search %}
            <span style="text-align: center">{{ pagination.info }}</span>
        {% endif %}
        <div class="mt-4 mb-4">
            {{ pagination.links }}
        </div>
        <table class="table table-striped table-bordered mb-4">
            <col style="width:15%">
            <col style="width:64%">
            <col style="width:5%">
            <col style="width:8%">
            <col style="width:8%">
            <thead>
            <tr class="border-bottom">
                <th class="pl-1">ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Certification date</th>
                <th>Archive date</th>
            </tr>
            </thead>
            {% for cert in certs %}
                {% set idd = cert["heuristics"]["cert_id"]|default("", true) %}
                {% set name = cert["name"] %}
                {% set status = cert["status"] %}
                {% set hashid = cert["_id"] %}
                {% set cert_date = cert["not_valid_before"] %}
                {% set archive_date = cert["not_valid_after"] %}
                {% set category = cert["category"] %}
                <tr>
                    <td class="pl-1">{{ render_category(category) }}&nbsp;{{ idd }}</td>
                    <td><a href="{{ url_for('.entry', hashid=hashid) }}">{{ name }}</a></td>
                    <td>{{ render_status(status) }}</td>
                    <td>{{ cert_date|strftime("%d.%m.%Y") if cert_date else "" }}</td>
                    <td>{{ archive_date|strftime("%d.%m.%Y") if archive_date else "" }}</td>
                </tr>
            {% endfor %}
        </table>
        <div class="mb-4">
            {{ pagination.links }}
        </div>
    </div>
{%- endmacro %}